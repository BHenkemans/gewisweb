<?php

$locale = $this->translator->getLocale();

// set title
if (isset($this->company)) {
    $this->headTitle($this->company->getName());
}
$this->headTitle($this->category->getPluralName());


?>
<section class="section section-breadcrumb">
    <div class="container">
        <ol class="breadcrumb">
            <li>
                <a href="<?= $this->url('company') ?>">
                    <?= $this->translate('Companies') ?>
                </a>
            </li>
            <?php if (isset($this->company)): ?>
                <li>
                    <a href="<?= $this->url('company/companyItem', ['slugCompanyName' => $this->company->getSlugName()]) ?>">
                        <?= $this->company->getName(); ?>
                    </a>
                </li>
            <?php endif; ?>
            <li class="active">
                <?= $category->getPluralName()?>
            </li>
        </ol>
    </div>
</section>

<section class="section">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1><?= $category->getPluralName() ?></h1>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12" style="margin-bottom: 1em">
                <?php if (isset($this->company)): ?>
                    <span class="text-muted" style="margin-right: 0.5em;"><?= $this->translate('Selected filters:') ?></span>
                    <a href="<?= $this->url('company/jobList', ['category' => $category->getSlug()]) ?>" class="btn btn-default btn-filter align-middle">
                        <span class="btn-text" title="<?= $company->getName() ?>">
                            <?= $company->getName() ?>
                        </span>
                        <span class="glyphicon glyphicon-trash small"></span>
                    </a>
                <?php endif; ?>
                <?php if (!empty($jobList)): ?>
                <fieldset id="filter-form" class="form-inline pull-right">
                    <div class="form-group">
                        <label for="filter-input"><?= $this->translate('Search:') ?></label>
                        <div class="btn-group">
                            <input
                                type="text"
                                class="form-control"
                                id="filter-input"
                                placeholder="<?= $this->translate('Search title or companies') ?>" />
                        </div>
                    </div>
                </fieldset>
                <?php endif; ?>
            </div>
        </div>
        <?php if (empty($jobList)): ?>
        <div class="row">
            <div class="col-md-12" style="margin-top: 1em">
                <h4>No Results</h4>
                <p><?= sprintf($this->translate("Unfortunately, there aren't any %s at the moment."), strtolower($category->getPluralName())) ?></p>
            </div>
        </div>
        <?php else: ?>
        <div class="row">
            <div class="col-md-12">
                <div class="feedback">
                    <p class="small text-muted">
                        <?= $this->translate('Showing results for') ?>&nbsp;<strong class="feedback-text"></strong>
                    </p>
                </div>
                <div class="card-grid">
                    <?php foreach ($jobList as $job): ?>
                    <?php
                        $company = $job->getPackage()->getCompany();

                        $jobUrl = $this->url('company/companyItem/joblist/job_item', [
                            'slugCompanyName' => $company->getSlugName(),
                            'slugJobName'     => $job->getSlugName(),
                            'category'        => $job->getCategory()->getSlug(),
                        ]);
                    ?>
                    <a href="<?= $jobUrl ?>" class="card job-card">
                        <div class="card-img">
                            <img
                                src="<?= $this->fileUrl($company->getTranslationFromLocale($locale)->getLogo()) ?>"
                                alt="<?= $this->escapeHtmlAttr($company->getName()) ?>" />
                        </div>
                        <h2 class="card-title"><?= $job->getName() ?></h2>
                        <p class="card-subtitle text-muted"><?= $company->getName() ?></p>
                        <div>
                            <span class="label label-default" data-toggle="tooltip" title="Computer Science & Engineering">CSE</span>
                            <span class="label label-default" data-toggle="tooltip" title="Data Science">DS</span>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-link"><?= $this->translate('View job') ?></button>
                            <span class="small">
                                <?= sprintf($this->translate('Posted on %s'), $job->getTimestamp()->format('d-m-Y')) ?>
                            </span>
                        </div>
                    </a>
                    <?php endforeach; ?>
                </div>
            </div>
        </div>
        <?php endif; ?>
    </div>
</section>
<script type="text/javascript">
    var CardGrid = function($el, searchElements) {
        // Pre-compute the search texts of each card
        var cards = $('.card', $el).map(function () {
            return {
                target: $(this),
                text: $(searchElements, $(this)).text().toLowerCase()
            };
        }).get();

        return {
            applyFilter: function (query) {
                var q = query.toLowerCase();

                cards.forEach(function (card) {
                    // If the search query isn't contained in the card
                    if (card.text.indexOf(q) === -1) {
                        $(card.target).hide();
                    } else {
                        $(card.target).show();
                    }
                });
            },
            clearFilter: function () {
                cards.forEach(function (card) {
                    $(card.target).show();
                });
            }
        }
    };

    var Feedback = function ($el) {
        return {
            setVal: function (value) {
                if (value === '') {
                    return $el.hide();
                }

                if ($el.is(':hidden')) {
                    $el.show()
                }

                $(".feedback-text", $el).text(value);
            }
        }
    };

    cardGrid = new CardGrid($('.card-grid'), '.card-title, .card-subtitle');
    feedback = new Feedback($('.feedback'));

    $("#filter-input").keyup(function () {
        var query = $(this).val().trim();

        cardGrid.applyFilter(query);
        feedback.setVal(query);
    });

    $('[data-toggle="tooltip"]').tooltip({
        viewport: { "selector": ".card-grid" }
    });
</script>