<?php
$this->headTitle($this->translate('Create Activity'));
$this->headLink()
    ->prependStylesheet($this->basePath() . '/css/bootstrap-markdown.min.css')
    ->prependStylesheet($this->basePath() . '/css/jquery.datetimepicker.css');
$this->headScript()
    ->prependFile($this->basePath() . '/js/bootstrap-markdown.js')
    ->prependFile($this->basePath() . '/js/activity-create.js')
    ->prependFile($this->basePath() . '/js/jquery.datetimepicker.full.min.js');

$lang = $this->plugin('translate')->getTranslator()->getLocale();

$form->prepare();
$form->setAttribute('class', 'form-activity');
?>
<section class="section">
    <div class="container">
        <?= $this->form()->openTag($form) ?>
        <div class="row">
            <div class="col-md-12">
                <h1><?= $this->translate('Create an activity') ?></h1>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-12">
                        <h2><?= $this->translate('Organizer') ?></h2>
                        <p><?= $this->translate('Select the committee or fraternity responsible for this activity. Or "no organ" if this activity is not organised by an organ.') ?></p>
                    </div>
                    <div class="col-md-12">
                        <?php
                        $organ = $form->get('organ')
                            ->setAttribute('class', 'form-control')
                            ->setAttribute('id', 'organizing-organ');
                        ?>
                        <div class="form-group <?= $this->bootstrapElementError($organ) ?>">
                            <label for="<?= $organ->getAttribute('id') ?>" class="control-label label-required">
                                <?= $this->translate('Committee / fraternity') ?>
                            </label>
                            <?= $this->formSelect($organ) ?>
                            <?= $this->formElementErrors($organ) ?>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="row">
                    <div class="col-md-12">
                        <h2><?= $this->translate('Date and time') ?></h2>
                        <p><?= $this->translate('Enter the start and end date and time of this activity.') ?></p>
                    </div>
                    <div class="col-md-12">
                        <div class="row">
                            <div class="col-md-6">
                                <?php
                                $beginTime = $form->get('beginTime')
                                    ->setAttribute('class', 'form-control')
                                    ->setAttribute('id', 'begin-time');
                                ?>
                                <div class="form-group <?= $this->bootstrapElementError($beginTime) ?>">
                                    <label for="<?= $beginTime->getAttribute('id') ?>" class="control-label label-required">
                                        <?= $this->translate('Start date and time') ?>
                                    </label>
                                    <?= $this->formInput($beginTime) ?>
                                    <?= $this->formElementErrors($beginTime) ?>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <?php
                                $endTime = $form->get('endTime')
                                    ->setAttribute('class', 'form-control')
                                    ->setAttribute('id', 'end-time');
                                ?>
                                <div class="form-group <?= $this->bootstrapElementError($endTime) ?>">
                                    <label for="<?= $endTime->getAttribute('id') ?>" class="control-label label-required">
                                        <?= $this->translate('End date and time') ?>
                                    </label>
                                    <?= $this->formInput($endTime) ?>
                                    <?= $this->formElementErrors($endTime) ?>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <?= $this->partial('partial/create', [ 'form' => $form ]) ?>
        <div class="row">
            <div class="col-md-12">
                <h2><?= $this->translate('Activity Categories') ?></h2>
                <p><?= $this->translate('Add activity categories to your activity to give potential subscribers a better understanding of the activity.') ?></p>
            </div>
            <div class="col-md-12">
                <?php
                $categories = $form->get('categories');
                $categoriesName = $categories->getName();
                $categoryOptions = $categories->getValueOptions();
                $categorySelectedValues = $categories->getValue();
                ?>
                <?php if (empty($categoryOptions)): ?>
                    <p><i><?= $this->translate('There are currently no activity categories...') ?></i></p>
                <?php else: ?>
                    <fieldset>
                        <?php foreach ($categoryOptions as $option => $value): ?>
                            <?php
                            $checked = ($categorySelectedValues && in_array($option, $categorySelectedValues)) ?
                                'checked="checked"' : '';
                            ?>
                            <div class="chip chip-clickable chip-outlined">
                                <span class="chip-icon chip-check-icon fas fa-check-circle hidden"></span>
                                <label for="<?= $categoriesName ?>-<?= $option ?>" data-category-id="<?= $option ?>"
                                        class="chip-label">
                                    <?= $value->getText($lang) ?>
                                </label>
                                <input type="checkbox" name="<?= $categoriesName ?>[]"
                                    id="<?= $categoriesName ?>-<?= $option; ?>"
                                    value="<?= $option ?>" class="chip-checkbox" <?= $checked ?>>
                            </div>
                        <?php endforeach; ?>
                    </fieldset>
                <?php endif; ?>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <h2><?= $this->translate('Signup Lists') ?></h2>
                <p><?= $this->translate('Add signup lists to allow people to sign up for this activity. Each list can have optional fields to collect specific information from the participants.') ?></p>
            </div>
            <div class="col-md-12">
                <div class="row signup-lists-header">
                    <div class="col-md-3 col-md-offset-6">
                        <span class="flag-icon flag-icon-nl"></span>
                        <strong><?= $this->translate('Dutch') ?></strong>
                        <hr />
                    </div>
                    <div class="col-md-3">
                        <span class="flag-icon flag-icon-en"></span>
                        <strong><?= $this->translate('English') ?></strong>
                        <hr />
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <?php
                        // Render template for SignupLists
                        $signupLists = $form->get('signuplists')->getTemplateElement();
                        ob_start();
                        echo $this->partial('partial/signuplist.phtml', ['signupList' => $signupLists, 'index' => '__signuplist__']);
                        $signupListsTemplate = trim(ob_get_clean());
                        ?>
                        <fieldset class="signup-lists">
                            <span class="template" data-template="<?= $this->escapeHtmlAttr($signupListsTemplate) ?>"></span>
                            <?php
                            $index = 0;
                            foreach ($form->get('signuplists')->getIterator() as $signupList) {
                                echo $this->partial('partial/signuplist.phtml', ['signupList' => $signupList, 'index' => $index]);
                                $index++;
                            }
                            ?>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group signup-list-controls">
                                        <button class="btn btn-danger" type="button" onclick="return Activity.removeSignupList()">
                                            <i class="fas fa-minus"></i>
                                            <?= $this->translate('Remove the last signup list') ?>
                                        </button>
                                        <button class="btn btn-success" type="button" onclick="return Activity.addSignupList()">
                                            <i class="fas fa-plus"></i>
                                            <?= $this->translate('Add a signup list') ?>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <?php
                $submit = $form->get('submit')
                    ->setLabel($this->translate('Create Activity'))
                    ->setAttribute('class', 'btn btn-primary');
                ?>
                <div class="form-group">
                    <?= $this->formButton($submit) ?>
                </div>
            </div>
            <?= $this->form()->closeTag(); ?>
        </div>
    </div>
</section>

<script>
    $('[name="beginTime"]').datetimepicker();
    $('[name="endTime"]').datetimepicker();
    $('.markdown-editor').each(function() {
      $(this).markdown(
        {
          resize: "both",
          iconlibrary: "fa"
        }
      );
    });
    Activity.updateForm();
    Activity.updateAllFields();
    Activity.updateAllCategories();
    $('label[for^="categories-"]').on('click', function() {
        Activity.toggleCategory($(this).data('category-id'));
    });
</script>
