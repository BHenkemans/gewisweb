<?php
$this->headScript()
    ->prependFile($this->basePath() . '/js/calendar.min.js')
    ->prependFile($this->basePath() . '/js/underscore-min.js')
    ->prependFile($this->basePath() . '/js/jquery.datetimepicker.full.min.js');
$this->headLink()
    ->prependStylesheet($this->basePath() . '/css/calendar.css')
    ->prependStylesheet($this->basePath() . '/css/jquery.datetimepicker.css');
$form->prepare();
?>
<style>
    .row-offset-top {
        margin-top: 20px;
    }

    .dropdown-spacing {
        padding: 10px;
    }
</style>
<div class="container">
    <div class="row">
        <h1><?= $this->translate("Calendar") ?></h1>
    </div>

    <div class="row pull-right">
        <button class="btn btn-default" type="button">
            <a href="<?= $this->url('activity/create') ?>">
                <i class="glyphicon glyphicon-plus-sign"></i>
                <?= $this->translate('Add activity') ?>
            </a>
        </button>
        &nbsp;
        <div class="dropdown pull-right<?= $optionError ? ' open' : ''?>">
            <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">
                <i class="glyphicon glyphicon-question-sign"></i>
                <?= $this->translate('Add option') ?>
            </button>
            <div class="dropdown-menu dropdown-spacing">
                <form class="form" method="post" style="width: 300px;">
                    <?php
                    $name = $form->get('name');
                    $name->setAttribute('class', 'form-control');
                    ?>
                    <div class="form-group<?= count($name->getMessages()) > 0 ? ' has-error' : '' ?>">
                        <label for="<?= $name->getName() ?>">
                            <?= $this->translate('Name') ?>
                        </label>
                        <?= $this->formInput($name) ?>
                        <?= $this->formElementErrors($name) ?>
                    </div>
                    <?php
                    $beginTime = $form->get('beginTime');
                    $beginTime->setAttribute('class', 'form-control datepicker');
                    $endTime = $form->get('endTime');
                    $endTime->setAttribute('class', 'form-control datepicker');
                    ?>
                    <div class="form-group<?= count($beginTime->getMessages()) > 0 ? ' has-error' : '' ?>">
                        <label for="<?= $beginTime->getName() ?>"><?= $this->translate('From') ?></label>
                        <?= $this->formInput($beginTime) ?>
                        <?= $this->formElementErrors($beginTime) ?>
                    </div>

                    <div class="form-group<?= count($endTime->getMessages()) > 0 ? ' has-error' : '' ?>">
                        <label for="<?= $endTime->getName() ?>"><?= $this->translate('Until') ?></label>
                        <?= $this->formInput($endTime) ?>
                        <?= $this->formElementErrors($endTime) ?>
                    </div>
                    <?php
                    $organ = $form->get('organ');
                    $organ->setAttribute('class', 'form-control');
                    ?>
                    <div class="form-group<?= count($organ->getMessages()) > 0 ? ' has-error' : '' ?>">
                        <label for="<?= $organ->getName(); ?>">
                            <?= $this->translate('Organizing committee / fraternity') ?>
                        </label>
                        <?= $this->formSelect($organ) ?>
                        <?= $this->formElementErrors($organ) ?>
                    </div>
                    <button type="submit" class="btn btn-primary"><?= $this->translate('Submit') ?></button>
                </form>
            </div>
        </div>


    </div>

    <div class="row">
        <div class="btn-group">
            <button class="btn btn-primary" data-calendar-nav="prev"><i class="glyphicon glyphicon-chevron-left"></i></button>
            <button class="btn btn-default" data-calendar-nav="today"><?= $this->translate("Today") ?></button>
            <button class="btn btn-primary" data-calendar-nav="next"><i class="glyphicon glyphicon-chevron-right"></i></button>
        </div>
        <div class="btn-group">
            <button class="btn btn-default" data-calendar-view="year">Year</button>
            <button class="btn btn-default active" data-calendar-view="month">Month</button>
            <button class="btn btn-default" data-calendar-view="week">Week</button>
            <button class="btn btn-default" data-calendar-view="day">Day</button>
        </div>
    </div>

    <div class="row row-offset-top">
        <div id="calendar"></div>
    </div>
</div>
<script type="text/javascript">
    $('.datepicker').datetimepicker();
    var calendar;
    var timeMin = new Date();
    timeMin.setDate(timeMin.getDate() - 180);
    timeMinString = timeMin.getYear() + '-' + timeMin.getMonth() + '-' + timeMin.getDay() + 'T0:00:00Z'
    $.getJSON('https://www.googleapis.com/calendar/v3/calendars/<?= $calendarKey ?>@group.calendar.google.com/events?key=<?= $APIKey ?>&maxResults=2500&showDeleted=false&timeMin=' + timeMinString, function(data) {
        var calendarItems = [
            <?php foreach($options as $option): ?>
            {
                "isPlanned": "false",
                "isOwner": "false",
                "id": "<?= $option->getId() ?>",
                "title": "<?= $this->escapeHtml($option->getName()) ?>",
                "url": "#",
                "class": "event-info",
                "start": <?= $option->getBeginTime()->getTimestamp() * 1000 ?>,
                "end": <?= $option->getEndTime()->getTimestamp() * 1000?>
            },
            <?php endforeach ?>
        ];
        $.each( data.items, function( key, item ) {
            if (item.status != 'cancelled') {
                calendarItems.push({
                    "isPlanned": "true",
                    "isOwner": "false",
                    "id": item.id,
                    "title": item.summary,
                    "url": item.htmlLink,
                    "class": "event-important",
                    "start": (new Date(item.start.dateTime !== undefined ? item.start.dateTime : item.start.date)).getTime(),
                    "end": (new Date(item.end.dateTime !== undefined ? item.end.dateTime : item.end.date)).getTime(),
                });
            }
        });
        calendar = $("#calendar").calendar(
            {
                tmpl_path: "/tmpls/",
                events_source: function () { return calendarItems; }
            });
    });
    $('.btn-group button[data-calendar-nav]').each(function() {
        var $this = $(this);
        $this.click(function() {
            calendar.navigate($this.data('calendar-nav'));
        });
    });
    $('.btn-group button[data-calendar-view]').each(function() {
        var $this = $(this);
        $this.click(function() {
            calendar.view($this.data('calendar-view'));
        });
    });
    $('#first_day').change(function(){
        var value = $(this).val();
        value = value.length ? parseInt(value) : null;
        calendar.setOptions({first_day: value});
        calendar.view();
    });
    $('#language').change(function(){
        calendar.setLanguage($(this).val());
        calendar.view();
    });
    $('#events-in-modal').change(function(){
        var val = $(this).is(':checked') ? $(this).val() : null;
        calendar.setOptions({modal: val});
    });
    $('#format-12-hours').change(function(){
        var val = $(this).is(':checked') ? true : false;
        calendar.setOptions({format12: val});
        calendar.view();
    });
    $('#show_wbn').change(function(){
        var val = $(this).is(':checked') ? true : false;
        calendar.setOptions({display_week_numbers: val});
        calendar.view();
    });
    $('#show_wb').change(function(){
        var val = $(this).is(':checked') ? true : false;
        calendar.setOptions({weekbox: val});
        calendar.view();
    });
    $('#events-modal .modal-header, #events-modal .modal-footer').click(function(e){
        //e.preventDefault();
        //e.stopPropagation();
    });
</script>
