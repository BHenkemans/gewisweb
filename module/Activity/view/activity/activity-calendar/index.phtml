<?php
$this->headScript()
    ->prependFile($this->basePath() . '/js/calendar.min.js')
    ->prependFile($this->basePath() . '/js/underscore-min.js')
    ->prependFile($this->basePath() . '/js/jquery.datetimepicker.full.min.js');
$this->headLink()
    ->prependStylesheet($this->basePath() . '/css/calendar.css')
    ->prependStylesheet($this->basePath() . '/css/jquery.datetimepicker.css');
$form->prepare();
?>
<style>
    .row-offset-top {
        margin-top: 20px;
    }

    .dropdown-spacing {
        padding: 10px;
    }
</style>
<div class="container">
    <div class="row">
        <h1><?= $this->translate('Activity calendar') ?></h1>
        <hr/>
    </div>
    <div class="row">
        <h3 class="pull-left">
            <div class="btn-group">
                <button class="btn btn-primary" data-calendar-nav="prev">
                    <i class="glyphicon glyphicon-chevron-left"></i>
                </button>
                <button class="btn btn-default" data-calendar-nav="today">
                    <?= $this->translate("Today") ?>
                </button>
                <button class="btn btn-primary" data-calendar-nav="next">
                    <i class="glyphicon glyphicon-chevron-right"></i>
                </button>
            </div>
            <div class="btn-group">
                <button class="btn btn-default" data-calendar-view="year">
                    <?= $this->translate("Year") ?>
                </button>
                <button class="btn btn-default active" data-calendar-view="month">
                    <?= $this->translate("Month") ?>
                </button>
            </div>

            <span id="calendarTitle"></span>
        </h3>
        <div class="pull-right">
            <div class="dropdown pull-right">
                <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">
                    <i class="glyphicon glyphicon-plus"></i>
                    <span class="hidden-xs"><?= $this->translate('Add option') ?></span>
                </button>
                <div class="dropdown-menu dropdown-spacing">
                    <form class="form" method="post" style="width: 300px;">
                        <?php
                        $name = $form->get('name');
                        $name->setAttribute('class', 'form-control');
                        ?>
                        <div class="form-group<?= count($name->getMessages()) > 0 ? ' has-error' : '' ?>">
                            <label for="<?= $name->getName() ?>">
                                <?= $this->translate('Name') ?>
                            </label>
                            <?= $this->formInput($name) ?>
                            <?= $this->formElementErrors($name) ?>
                        </div>
                        <?php
                        $beginTime = $form->get('beginTime');
                        $beginTime->setAttribute('class', 'form-control datepicker');
                        $endTime = $form->get('endTime');
                        $endTime->setAttribute('class', 'form-control datepicker');
                        ?>
                        <div class="form-group<?= count($beginTime->getMessages()) > 0 ? ' has-error' : '' ?>">
                            <label for="<?= $beginTime->getName() ?>"><?= $this->translate('From') ?></label>
                            <?= $this->formInput($beginTime) ?>
                            <?= $this->formElementErrors($beginTime) ?>
                        </div>

                        <div class="form-group<?= count($endTime->getMessages()) > 0 ? ' has-error' : '' ?>">
                            <label for="<?= $endTime->getName() ?>"><?= $this->translate('Until') ?></label>
                            <?= $this->formInput($endTime) ?>
                            <?= $this->formElementErrors($endTime) ?>
                        </div>
                        <?php
                        $organ = $form->get('organ');
                        $organ->setAttribute('class', 'form-control');
                        ?>
                        <div class="form-group<?= count($organ->getMessages()) > 0 ? ' has-error' : '' ?>">
                            <label for="<?= $organ->getName(); ?>">
                                <?= $this->translate('Organizing committee / fraternity') ?>
                            </label>
                            <?= $this->formSelect($organ) ?>
                            <?= $this->formElementErrors($organ) ?>
                        </div>
                        <button type="submit" class="btn btn-primary"><?= $this->translate('Submit') ?></button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="row row-offset-top">
        <div id="calendar"></div>
    </div>
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title"><?= $this->translate('Delete option') ?></h4>
                </div>
                <div class="modal-body">
                    <p><?= $this->translate('Are you sure you want to delete this option?') ?></p>
                </div>
                <div class="modal-footer">
                    <form method="post" action="delete" class="form form-inline form-delete">
                        <input type="hidden" name="option_id" id="deleteOptionId"/>
                        <button type="button" class="btn btn-default" data-dismiss="modal"><?= $this->translate('Cancel') ?></button>
                        <button type="submit" class="btn btn-danger"><i class="glyphicon glyphicon-trash" aria-hidden="true"></i>&nbsp;<?= $this->translate('Delete') ?></button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    $('.datepicker').datetimepicker();
    var calendar;
    var timeMin = new Date();
    timeMin.setDate(timeMin.getDate() - 180);
    timeMinString = timeMin.getYear() + '-' + timeMin.getMonth() + '-' + timeMin.getDay() + 'T0:00:00Z';
    var result = $.getJSON('https://www.googleapis.com/calendar/v3/calendars/<?= $calendarKey ?>@group.calendar.google.com/events?key=<?= $APIKey ?>&maxResults=2500&showDeleted=false&timeMin=' + timeMinString, function(data) {
        var calendarItems = [
            <?php foreach($options as $option): ?>
            {
                "isPlanned": "false",
                "isOwner": true,
                "id": "<?= $option->getId() ?>",
                "title": "<?= $this->escapeHtml($option->getName()) ?>",
                "organizer": "<?= $option->getOrgan() === null ? $option->getCreator()->getMember()->getFullName() : $option->getOrgan()->getAbbr() ?>",
                "url": "#",
                "class": "event-info",
                "start": <?= $option->getBeginTime()->getTimestamp() * 1000 ?>,
                "end": <?= $option->getEndTime()->getTimestamp() * 1000?>
            },
            <?php endforeach ?>
        ];
        $.each( data.items, function( key, item ) {
            if (item.status != 'cancelled') {
                calendarItems.push({
                    "isPlanned": "true",
                    "isOwner": false,
                    "id": item.id,
                    "title": item.summary,
                    "url": item.htmlLink,
                    "class": "event-important",
                    "start": (new Date(item.start.dateTime !== undefined ? item.start.dateTime : item.start.date)).getTime(),
                    "end": (new Date(item.end.dateTime !== undefined ? item.end.dateTime : item.end.date)).getTime(),
                });
            }
        });
        calendar = $("#calendar").calendar(
            {
                tmpl_path: "/tmpls/",
                events_source: function () { return calendarItems; },
                views: {
                    year: {
                        slide_events: 1,
                        enable: 1
                    },
                    month: {
                        slide_events: 1,
                        enable: 1
                    },
                    week: {
                        enable: 0
                    },
                    day: {
                        enable: 0
                    }
                },
                onAfterViewLoad: function(view) {
                    $('#calendarTitle').text(this.getTitle());
                },
            });
    });


    $('.btn-group button[data-calendar-nav]').each(function() {
        var $this = $(this);
        $this.click(function() {
            calendar.navigate($this.data('calendar-nav'));
        });
    });
    $('.btn-group button[data-calendar-view]').each(function() {
        var $this = $(this);
        $this.click(function() {
            $('.active').removeClass('active');
            $this.addClass('active');
            calendar.view($this.data('calendar-view'));
        });
    });

    var showDeleteModal = function(optionId) {
        $('#deleteOptionId').val(optionId);
        $('#deleteModal').modal('show');
    };
</script>
